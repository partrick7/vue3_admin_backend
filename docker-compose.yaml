services:
  vue3_admin_mysql:
    image: registry.cn-shanghai.aliyuncs.com/wangjian3306/mysql:8.0
    container_name: vue3_admin_mysql
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: vue3_admin
      MYSQL_USER: vue3_admin
      MYSQL_PASSWORD: password
      # 减少MySQL内存占用的关键配置
      MYSQL_INITDB_SKIP_TZINFO: "1"  # 跳过时区信息初始化
    ports:
      - "3306:3306"
    volumes:
      - ./init-sql/:/docker-entrypoint-initdb.d/
      # 添加自定义MySQL配置文件
      - ./mysql-conf.d/:/etc/mysql/conf.d/
    command:
      --default-authentication-plugin=mysql_native_password
      --innodb-buffer-pool-size=128M        # 减少InnoDB缓冲池大小
      --innodb-log-file-size=32M            # 减小日志文件大小
      --max-connections=50                  # 减少最大连接数
      --table-definition-cache=400          # 减少表定义缓存
      --table-open-cache=400                # 减少表打开缓存
      --performance-schema=0                # 禁用性能模式以节省内存
      --skip-name-resolve                   # 跳过DNS解析
      --query-cache-size=0                  # 禁用查询缓存
      --query-cache-type=0
    # 限制容器内存使用
    mem_limit: 350m
    mem_reservation: 256m
  
  vue3_admin_backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: vue3_admin_backend
    restart: always
    environment:
      TZ: Asia/Shanghai
      VUE3_ADMIN_MYSQL_USER: vue3_admin
      VUE3_ADMIN_MYSQL_DATABASE: vue3_admin
      VUE3_ADMIN_MYSQL_PASSWORD: password
      VUE3_ADMIN_MYSQL_HOST: vue3_admin_mysql
    ports:
      - "10086:10086"
    depends_on:
      - vue3_admin_mysql
    links:
      - vue3_admin_mysql
